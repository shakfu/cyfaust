name: Windows-Plus

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: '2.69.3'
        submodules: true
        fetch-depth: '1'

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1
  
    - name: Get latest CMake and ninja
      uses: lukka/get-cmake@latest

    # - name: patch backend and target
    #   run: |
    #     Invoke-WebRequest https://raw.githubusercontent.com/shakfu/cyfaust/main/scripts/patch/interp_plus_backend.cmake -OutFile ${{ github.workspace }}/build/backends/regular.cmake
    #     Invoke-WebRequest https://raw.githubusercontent.com/shakfu/cyfaust/main/scripts/patch/interp_plus_target.cmake -OutFile ${{ github.workspace }}/build/targets/win-ci.cmake

    - name: patch backend and target
      env:
        PATCH: https://raw.githubusercontent.com/shakfu/cyfaust/main/scripts/patch
      run: |
        curl -L ${{env.PATCH}}/interp_plus_backend.cmake -o ${{ github.workspace }}/build/backends/regular.cmake
        curl -L ${{env.PATCH}}/interp_plus_target.cmake -o ${{ github.workspace }}/build/targets/win-ci.cmake

    - name: Build Faust
      run: |
        make -C build cmake BACKENDS=regular.cmake TARGETS=win-ci.cmake
        make -C build

    - uses: actions/upload-artifact@v4
      with:
        name: faustlibs-2.69.3-windows-latest
        path: ${{ github.workspace }}/build/lib/libfaust.*